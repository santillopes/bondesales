{% extends "layout.html" %}

{% block title %}Dashboard de Revenda{% endblock %}

{% block main %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        corePlugins: {
            preflight: false, // IMPORTANTE: Impede que o Tailwind estrague o Navbar do Bootstrap
        },
        theme: {
            extend: {
                colors: {
                    'primary': '#4f46e5',
                    'secondary': '#8b5cf6',
                    'success': '#10b981',
                    'warning': '#f59e0b',
                    'danger': '#ef4444',
                    'info': '#3b82f6',
                }
            }
        }
    }
</script>

<style>
    /* Reaplica fonte sans-serif limpa no container do dashboard */
    .dashboard-container {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .metric-card {
        border-left: 4px solid var(--color);
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        background-color: white;
    }
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    /* Estilos para ordenação */
    th.sortable {
        cursor: pointer;
        user-select: none;
    }
    th.sortable:hover {
        background-color: #f3f4f6;
    }
    /* Ajuste para inputs do Tailwind conviverem com Bootstrap */
    .tw-input {
        display: block;
        width: 100%;
        border-radius: 0.5rem;
        border-color: #d1d5db;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .tw-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.15s ease-in-out;
    }
    
</style>

<div class="dashboard-container">
    
    <header class="mb-8">
        <h1 class="text-3xl font-extrabold text-gray-900 border-b pb-2 mb-2">
            Sistema de Gestão do Bonde
        </h1>
    </header>

    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Selecionar Utilizador</h2>
        <form action="/" method="GET" class="space-y-4">
            <div class="flex flex-col sm:flex-row sm:items-end sm:space-x-4">
                <div class="flex-grow">
                    <label for="user_id" class="block text-sm font-medium text-gray-700 mb-1">Utilizador</label>
                    <select id="user_id" name="user_id" class="tw-input border-gray-300 focus:ring-primary focus:border-primary p-2 border">
                        <option value="">Selecione um Utilizador</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if user.id == selected_user_id %}selected{% endif %}>
                                {{ user.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="tw-btn mt-4 sm:mt-0 bg-primary text-white shadow-md hover:bg-indigo-700">
                    Carregar Dados
                </button>
            </div>
        </form>
    </section>

    {% if selected_user_id %}
    
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Dashboard de {{ selected_user_name }}</h2>

    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Resumo de Desempenho</h3>
        
        {% if user_metrics %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="metric-card p-4 rounded-lg shadow-md" style="--color: #10b981;">
                <p class="text-sm font-medium text-gray-500">Lucro Total</p>
                <p class="text-2xl font-bold text-gray-900">{{ '€{:,.2f}'.format(user_metrics.lucro) }}</p>
            </div>
            <div class="metric-card p-4 rounded-lg shadow-md" style="--color: #3b82f6;">
                <p class="text-sm font-medium text-gray-500">Faturação Total</p>
                <p class="text-2xl font-bold text-gray-900">{{ '€{:,.2f}'.format(user_metrics.faturacao) }}</p>
            </div>
            <div class="metric-card p-4 rounded-lg shadow-md" style="--color: #ef4444;">
                <p class="text-sm font-medium text-gray-500">Gastos Totais</p>
                <p class="text-2xl font-bold text-gray-900">{{ '€{:,.2f}'.format(user_metrics.gastos) }}</p>
            </div>
            <div class="metric-card p-4 rounded-lg shadow-md" style="--color: #8b5cf6;">
                <p class="text-sm font-medium text-gray-500">ROI/Multiplicador</p>
                <p class="text-2xl font-bold text-gray-900">{{ '{:,.2f}%'.format(user_metrics.multiplicador * 100) }}</p>
                <p class="text-xs text-gray-500 mt-1">(Lucro / Gastos)</p>
            </div>
            
            <div class="lg:col-span-4 h-px bg-gray-200 my-2"></div>

            <div class="metric-card p-4 rounded-lg shadow-md" style="--color: #f59e0b;">
                <p class="text-sm font-medium text-gray-500">Investido em Stock</p>
                <p class="text-2xl font-bold text-gray-900">{{ '€{:,.2f}'.format(user_metrics.invested_stock_cost) }}</p>
            </div>
            <div class="metric-card p-4 rounded-lg shadow-md" style="--color: #10b981;">
                <p class="text-sm font-medium text-gray-500">Lucro Estimado Stock</p>
                <p class="text-2xl font-bold text-gray-900">{{ '€{:,.2f}'.format(user_metrics.estimated_stock_profit) }}</p>
            </div>
             <div class="metric-card p-4 rounded-lg shadow-md" style="--color: #4f46e5;">
                <p class="text-sm font-medium text-gray-500">Encomendas em Stock</p>
                <p class="text-2xl font-bold text-gray-900">{{ user_metrics.encomendas_stock }}</p>
            </div>
            <div class="metric-card p-4 rounded-lg shadow-md" style="--color: #ef4444;">
                <p class="text-sm font-medium text-gray-500">Dias Estimados Fim Stock</p>
                <p class="text-2xl font-bold text-gray-900">{{ user_metrics.dias_fim_stock|round|int }}</p>
            </div>
        </div>
        {% else %}
            <p class="text-gray-600">Nenhuma métrica disponível.</p>
        {% endif %}
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <section class="bg-white p-6 rounded-xl shadow-lg h-full">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 text-primary">Adicionar Nova Encomenda</h3>
            <form action="{{ url_for('add_order') }}" method="POST" class="space-y-4">
                <input type="hidden" name="user_id" value="{{ selected_user_id }}">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Produto *</label>
                        <select name="product_id" required class="tw-input p-2 border">
                            <option value="">Selecione</option>
                            {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Marca *</label>
                        <select name="brand_id" required class="tw-input p-2 border">
                            <option value="">Selecione</option>
                            {% for brand in brands %}
                                <option value="{{ brand.id }}">{{ brand.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tamanho *</label>
                        <select name="size_id" required class="tw-input p-2 border">
                            <option value="">Selecione</option>
                            {% for size in sizes %}
                                <option value="{{ size.id }}">{{ size.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Cor *</label>
                        <select name="color_id" required class="tw-input p-2 border">
                            <option value="">Selecione</option>
                            {% for color in colors %}
                                <option value="{{ color.id }}">{{ color.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Preço Custo (€) *</label>
                        <input type="number" step="0.01" name="price" required class="tw-input p-2 border" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Taxa Entrega (€)</label>
                        <input type="number" step="0.01" name="deliver_tax" class="tw-input p-2 border" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data Pedido *</label>
                        <input type="date" name="order_date" required class="tw-input p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data Entrega</label>
                        <input type="date" name="delivery_date" class="tw-input p-2 border">
                    </div>
                </div>
                <button type="submit" class="tw-btn w-full bg-primary text-white hover:bg-indigo-700">Adicionar Encomenda</button>
            </form>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-lg h-full">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 text-secondary">Adicionar Post / Venda</h3>
            <form action="{{ url_for('add_post') }}" method="POST" class="space-y-4">
                <input type="hidden" name="user_id" value="{{ selected_user_id }}">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Encomenda (Stock) *</label>
                    <select id="order_id_post" name="order_id" required class="tw-input p-2 border">
                        <option value="">Selecione a Encomenda</option>
                        {% for order in orders %}
                            {% if order.status != 'sold' %}
                                <option value="{{ order.order_id }}">
                                    #{{ order.order_id }} - {{ order.product_name }} / {{ order.brand_name }} ({{ order.status.capitalize() }})
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Preço Anúncio (€) *</label>
                        <input type="number" step="0.01" id="first_price" name="first_price" required class="tw-input p-2 border" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Taxa Destaque (€)</label>
                        <input type="number" step="0.01" name="ad_tax" class="tw-input p-2 border" placeholder="0.00">
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Data Post *</label>
                        <input type="date" name="post_date" required class="tw-input p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hora Post (Opc.)</label>
                        <input type="time" name="post_time" class="tw-input p-2 border">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Preço Vendido (€)</label>
                        <input type="number" step="0.01" name="sell_price" class="tw-input p-2 border" placeholder="Se vendido">
                    </div>

                    <div class="sm:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Data Venda</label>
                        <input type="date" name="sell_date" class="tw-input p-2 border">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hora Venda (Opc.)</label>
                        <input type="time" name="sell_time" class="tw-input p-2 border">
                    </div>

                    <div class="sm:col-span-4">
                        <p class="text-xs text-gray-500 mt-1">Preencher Preço e Data Venda apenas se já vendido.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t pt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Views</label>
                        <input type="number" name="views" class="tw-input p-2 border" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Likes</label>
                        <input type="number" name="likes" class="tw-input p-2 border" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Propostas</label>
                        <input type="number" name="proposals" class="tw-input p-2 border" placeholder="0">
                    </div>
                </div>
                <button type="submit" class="tw-btn w-full bg-secondary text-white hover:bg-purple-700">Adicionar Post</button>
            </form>
        </section>
    </div>

    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
            <span>Vendas Concretizadas</span>
            <span class="text-sm font-normal text-gray-500">Exibindo 10 por página</span>
        </h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 sortable-table" id="sales-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="product">PRODUTO/MARCA/TAMANHO/COR</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="gastos" data-sort-type="number">Gastos Totais</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="sold_price" data-sort-type="number">Preço Vendido</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="lucro" data-sort-type="number">Lucro Líquido</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="tempo_total" data-sort-type="number">TEMPO TOTAL (dias)</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if sales_data %}
                        {% for sale in sales_data %}
                        <tr>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900" data-sort-value="{{ sale.product_info }}">{{ sale.product_info }} / {{ sale.size_name }} / {{ sale.color_name }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ sale.total_gastos }}">{{ '€{:,.2f}'.format(sale.total_gastos) }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 font-medium" data-sort-value="{{ sale.sell_price }}">{{ '€{:,.2f}'.format(sale.sell_price) }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-bold {% if sale.lucro >= 0 %}text-success-600{% else %}text-danger-600{% endif %}" data-sort-value="{{ sale.lucro }}">{{ '€{:,.2f}'.format(sale.lucro) }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ sale.days_to_sale_total }}">{{ sale.days_to_sale_total if sale.days_to_sale_total is not none else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="7" class="px-3 py-4 text-center text-gray-500">Nenhuma venda concretizada.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4" id="sales-pagination-footer">
            <div class="flex flex-1 justify-between sm:justify-center">
                <button id="sales-prev-btn" class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">Anterior</button>
                <span id="sales-page-info" class="mx-4 text-sm text-gray-700 self-center"></span>
                <button id="sales-next-btn" class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">Próximo</button>
            </div>
        </div>
    </section>
    
    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Stock e Encomendas (Stock/Shipping)</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 sortable-table" id="orders-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="status">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="product">PRODUTO/MARCA/TAMANHO/COR</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="price" data-sort-type="number">PREÇO CUSTO</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="deliver_tax" data-sort-type="number">TAXA ENTREGA</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="days_to_delivery_display" data-sort-type="number">TEMPO DE ENTREGA (dias)</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if orders %}
                        {% for order in orders %}
                        <tr>
                            <td class="px-3 py-2 whitespace-nowrap" data-sort-value="{{ order.status }}">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if order.status == 'sold' %}bg-success-100 text-success-800
                                    {% elif order.status == 'stock' %}bg-warning-100 text-warning-800
                                    {% elif order.status == 'shipping' %}bg-info-100 text-info-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ order.status.capitalize() }}
                                </span>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900" data-sort-value="{{ order.product_name }}">{{ order.product_name }} / {{ order.brand_name }} / {{ order.size_name }} / {{ order.color_name }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ order.price }}">{{ '€{:,.2f}'.format(order.price) }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ order.deliver_tax }}">{{ '€{:,.2f}'.format(order.deliver_tax) if order.deliver_tax else '€0.00' }}</td>
                            
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ order.days_to_delivery if order.days_to_delivery is not none else order.days_since_order }}">
                                {% if order.delivery_date %}
                                    {{ order.days_to_delivery }} dias
                                {% else %}
                                    *{{ order.days_since_order }} dias
                                {% endif %}
                            </td>
                            
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                                <a href="/" class="text-primary hover:text-indigo-900">Editar</a> <!-- {{ url_for('edit_order', order_id=order.order_id) }} -->
                                {% if order.status == 'stock' and not order.post_id %}
                                    <a href="#" onclick="document.getElementById('order_id_post').value='{{ order.order_id }}'; document.getElementById('first_price').focus();" class="text-secondary hover:text-purple-700">Anunciar</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">Nenhuma encomenda encontrada.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4" id="orders-pagination-footer">
            <div class="flex flex-1 justify-between sm:justify-center">
                <button id="orders-prev-btn" class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">Anterior</button>
                <span id="orders-page-info" class="mx-4 text-sm text-gray-700 self-center"></span>
                <button id="orders-next-btn" class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">Próximo</button>
            </div>
        </div>
    </section>
    
    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Posts (Anúncios Ativos e Concluídos)</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 sortable-table" id="posts-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="product">PRODUTO/MARCA/TAMANHO/COR</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="first_price" data-sort-type="number">Preço Anúncio</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="sold_price" data-sort-type="number">Preço Vendido</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="views" data-sort-type="number">Views</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="likes" data-sort-type="number">Likes</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="proposals" data-sort-type="number">Propostas</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="days_for_sale_display" data-sort-type="number">TEMPO (dias)</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sortable-field="status">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if posts %}
                        {% for post in posts %}
                        <tr>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900" data-sort-value="{{ post.product_name }}">{{ post.product_name }} / {{ post.brand_name }} / {{ post.size_name }} / {{ post.color_name }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ post.first_price }}">{{ '€{:,.2f}'.format(post.first_price) if post.first_price is not none else 'N/A' }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 font-medium" data-sort-value="{{ post.sell_price if post.sell_price is not none else -1 }}">
                                {{ '€{:,.2f}'.format(post.sell_price) if post.sell_price is not none else 'N/A' }}
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ post.views if post.views is not none else 0 }}">{{ post.views if post.views is not none else 0 }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ post.likes if post.likes is not none else 0 }}">{{ post.likes if post.likes is not none else 0 }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ post.proposals if post.proposals is not none else 0 }}">{{ post.proposals if post.proposals is not none else 0 }}</td>
                            
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" data-sort-value="{{ post.days_to_sale if post.days_to_sale is not none else post.days_since_post }}">
                                {% if post.status == 'sold' %}
                                    {{ post.days_to_sale }} dias (Vendido)
                                {% else %}
                                    {{ post.days_since_post }} dias (Anunciado)
                                {% endif %}
                            </td>

                            <td class="px-3 py-2 whitespace-nowrap" data-sort-value="{{ post.status }}">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if post.status == 'sold' %}bg-success-100 text-success-800
                                    {% elif post.status == 'active' %}bg-info-100 text-info-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ post.status.capitalize() }}
                                </span>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium">
                                <a href="/" class="text-primary hover:text-indigo-900">Editar</a> <!-- {{ url_for('edit_post', post_id=post.post_id) }} -->
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="9" class="px-3 py-4 text-center text-gray-500">Nenhum post encontrado.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4" id="posts-pagination-footer">
            <div class="flex flex-1 justify-between sm:justify-center">
                <button id="posts-prev-btn" class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">Anterior</button>
                <span id="posts-page-info" class="mx-4 text-sm text-gray-700 self-center"></span>
                <button id="posts-next-btn" class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">Próximo</button>
            </div>
        </div>
    </section>

    {% endif %}

</div>

<script>

    // Variável para armazenar o estado da ordenação (coluna e direção) e paginação

    let tableStates = {

        'orders-table': { page: 1, sortCol: 'order_date', sortDir: 'desc' },

        'posts-table': { page: 1, sortCol: 'post_date', sortDir: 'desc' },

        'sales-table': { page: 1, sortCol: 'sell_date', sortDir: 'desc' }

    };

    const ROWS_PER_PAGE = 10;



    // --- Funções de Ajuda ---



    /** Converte data DD/MM/YYYY para um objeto Date para comparação */

    function dateFromDDMMYYYY(dateString) {

        if (!dateString || dateString === 'Aguardando' || dateString === 'Em Aberto' || dateString === '99/99/9999') {

            return new Date(0); // Coloca datas vazias ou especiais no início para ordenação

        }

        const parts = dateString.split('/');

        return new Date(parts[2], parts[1] - 1, parts[0]);

    }



    /** Ordena a tabela */

    function sortTable(tableId, sortCol, sortDir) {

        const table = document.getElementById(tableId);

        const tbody = table.querySelector('tbody');

        const rows = Array.from(tbody.querySelectorAll('tr'));

       

        // Se não houver linhas (ex: "Nenhuma encomenda encontrada..."), sai

        if (rows.length === 0 || rows[0].querySelector('td').getAttribute('colspan')) {

             updatePagination(tableId, 0);

             return;

        }



        const header = table.querySelector('thead tr');

        let columnIndex = -1;

        let sortType = 'string';



        // 1. Encontrar o índice e tipo de ordenação

        Array.from(header.querySelectorAll('th')).forEach((th, index) => {

            if (th.getAttribute('data-sortable-field') === sortCol) {

                columnIndex = index;

                sortType = th.getAttribute('data-sort-type') || 'string';

            }

            // Limpar setas de ordenação

            th.innerHTML = th.textContent.replace(' ▲', '').replace(' ▼', '');

        });

       

        if (columnIndex === -1) return; // Coluna não encontrada



        // 2. Ordenar as linhas

        rows.sort((a, b) => {

            let aVal, bVal;

           

            // Obter o valor para ordenação (data-sort-value, data-display-value, ou textContent)

            const aCell = a.querySelectorAll('td')[columnIndex];

            const bCell = b.querySelectorAll('td')[columnIndex];

           

            // Tenta obter o valor numérico para ordenação

            aVal = parseFloat(aCell.getAttribute('data-sort-value')) || 0;

            bVal = parseFloat(bCell.getAttribute('data-sort-value')) || 0;

           

            // Se os valores numéricos forem 0, usa o tipo de ordenação mais específico

            if (aVal === 0 && bVal === 0) {

                if (sortType === 'date') {

                    aVal = dateFromDDMMYYYY(aCell.getAttribute('data-display-value') || aCell.textContent);

                    bVal = dateFromDDMMYYYY(bCell.getAttribute('data-display-value') || bCell.textContent);

                } else if (sortType === 'string') {

                    // Valor do texto ou do atributo, padronizado para comparação

                    aVal = (aCell.textContent || aCell.getAttribute('data-display-value') || '').toLowerCase();

                    bVal = (bCell.textContent || bCell.getAttribute('data-display-value') || '').toLowerCase();

                } else {

                    // Ordenação de números (se não for explicitamente string ou data)

                    aVal = parseFloat(aCell.textContent.replace(/[€\s,]/g, '').replace('.', '').replace(',', '.')) || 0;

                    bVal = parseFloat(bCell.textContent.replace(/[€\s,]/g, '').replace('.', '').replace(',', '.')) || 0;

                }

            } else {

                 sortType = 'number'; // Se encontrou valores numéricos válidos

            }



            let comparison = 0;

            if (sortType === 'date') {

                 comparison = aVal - bVal;

            } else if (sortType === 'number') {

                 comparison = aVal - bVal;

            } else { // String

                 if (aVal > bVal) comparison = 1;

                 else if (aVal < bVal) comparison = -1;

            }



            return sortDir === 'asc' ? comparison : -comparison;

        });



        // 3. Adicionar as linhas ordenadas de volta e atualizar o estado

        rows.forEach(row => tbody.appendChild(row));

        tableStates[tableId].sortCol = sortCol;

        tableStates[tableId].sortDir = sortDir;

       

        // 4. Exibir a seta de ordenação

        const currentHeader = header.querySelector(`[data-sortable-field="${sortCol}"]`);

        currentHeader.innerHTML += sortDir === 'asc' ? ' ▲' : ' ▼';



        // 5. Reiniciar paginação para a primeira página após a ordenação

        tableStates[tableId].page = 1;

        displayPage(tableId);

    }



    /** Exibe a página atual da tabela */

    function displayPage(tableId) {

        const table = document.getElementById(tableId);

        const tbody = table.querySelector('tbody');

        const rows = Array.from(tbody.querySelectorAll('tr'));

       

        // Ignora se não houver linhas de dados

        if (rows.length === 0 || rows[0].querySelector('td').getAttribute('colspan')) {

             updatePagination(tableId, 0);

             return;

        }

       

        const state = tableStates[tableId];

        const totalPages = Math.ceil(rows.length / ROWS_PER_PAGE);

        const start = (state.page - 1) * ROWS_PER_PAGE;

        const end = start + ROWS_PER_PAGE;



        rows.forEach((row, index) => {

            row.style.display = (index >= start && index < end) ? '' : 'none';

        });



        updatePagination(tableId, totalPages);

    }



    /** Atualiza os botões de paginação */

    function updatePagination(tableId, totalPages) {

        const state = tableStates[tableId];

        const prevBtn = document.getElementById(`${tableId}-prev-btn`);

        const nextBtn = document.getElementById(`${tableId}-next-btn`);

        const pageInfo = document.getElementById(`${tableId}-page-info`);

       

        if (totalPages <= 1) {

            if (prevBtn) prevBtn.classList.add('d-none');

            if (nextBtn) nextBtn.classList.add('d-none');

            if (pageInfo) pageInfo.textContent = '';

            return;

        }



        if (prevBtn) {

            prevBtn.classList.toggle('d-none', state.page === 1);

            prevBtn.onclick = () => { state.page--; displayPage(tableId); };

        }

       

        if (nextBtn) {

            nextBtn.classList.toggle('d-none', state.page === totalPages);

            nextBtn.onclick = () => { state.page++; displayPage(tableId); };

        }

       

        if (pageInfo) pageInfo.textContent = `Página ${state.page} de ${totalPages}`;

    }



    // --- Inicialização ---



    document.addEventListener('DOMContentLoaded', () => {

       

        // 1. Configurar manipuladores de clique para ordenação

        document.querySelectorAll('.sortable-table').forEach(table => {

            const tableId = table.id;

            const headerCells = table.querySelectorAll('thead th.sortable');



            headerCells.forEach(header => {

                header.style.cursor = 'pointer'; // Adiciona cursor de clique

                header.addEventListener('click', () => {

                    const field = header.getAttribute('data-sortable-field');

                    let newDir = 'asc';

                   

                    // Se estiver ordenando pela mesma coluna, inverte a direção

                    if (tableStates[tableId].sortCol === field) {

                        newDir = tableStates[tableId].sortDir === 'asc' ? 'desc' : 'asc';

                    }

                   

                    sortTable(tableId, field, newDir);

                });

            });

        });



        // 2. Aplicar ordenação e paginação iniciais

        // Aplica a ordenação inicial e exibe a primeira página

        sortTable('orders-table', tableStates['orders-table'].sortCol, tableStates['orders-table'].sortDir);

        sortTable('posts-table', tableStates['posts-table'].sortCol, tableStates['posts-table'].sortDir);

        sortTable('sales-table', tableStates['sales-table'].sortCol, tableStates['sales-table'].sortDir);

       

        // 3. Adicionar validação de formulário (Boostrap)

        const forms = document.querySelectorAll('.needs-validation')

        Array.from(forms).forEach(form => {

            form.addEventListener('submit', event => {

                if (!form.checkValidity()) {

                    event.preventDefault()

                    event.stopPropagation()

                }



                form.classList.add('was-validated')

            }, false)

        })



    });

</script>

{% endblock %}